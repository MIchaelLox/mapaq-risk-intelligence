<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - MAPAQ Risk Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-utensils text-2xl"></i>
                    <h1 class="text-2xl font-bold">MAPAQ Risk Intelligence</h1>
                </div>
                <div class="flex space-x-6">
                    <a href="/" class="hover:text-blue-200 transition">Accueil</a>
                    <a href="/dashboard" class="text-blue-200 font-semibold">Dashboard</a>
                    <a href="/predict-form" class="hover:text-blue-200 transition">Pr√©diction</a>
                    <a href="/about" class="hover:text-blue-200 transition">√Ä propos</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <div class="bg-gradient-to-r from-blue-500 to-blue-700 text-white py-12">
        <div class="container mx-auto px-6">
            <h2 class="text-4xl font-bold mb-2">üìä Dashboard Interactif</h2>
            <p class="text-xl">Visualisations et statistiques en temps r√©el</p>
            <p class="text-sm mt-2 opacity-90">D√©velopp√© par Grace Mandiangu</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-6 py-8">
        <!-- Stats Cards -->
        <div class="grid md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm mb-1">Total Restaurants</p>
                        <p class="text-3xl font-bold text-gray-800" id="total-restaurants">-</p>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-full">
                        <i class="fas fa-store text-blue-600 text-2xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm mb-1">Risque Faible</p>
                        <p class="text-3xl font-bold text-green-600" id="low-risk">-</p>
                    </div>
                    <div class="bg-green-100 p-3 rounded-full">
                        <i class="fas fa-check-circle text-green-600 text-2xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm mb-1">Risque Moyen</p>
                        <p class="text-3xl font-bold text-orange-600" id="medium-risk">-</p>
                    </div>
                    <div class="bg-orange-100 p-3 rounded-full">
                        <i class="fas fa-exclamation-circle text-orange-600 text-2xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm mb-1">Risque √âlev√©</p>
                        <p class="text-3xl font-bold text-red-600" id="high-risk">-</p>
                    </div>
                    <div class="bg-red-100 p-3 rounded-full">
                        <i class="fas fa-times-circle text-red-600 text-2xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 1 -->
        <div class="grid md:grid-cols-2 gap-6 mb-6">
            <!-- Risk Distribution Pie Chart -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-xl font-bold mb-4 text-gray-800">
                    <i class="fas fa-chart-pie text-blue-600 mr-2"></i>
                    Distribution des Risques
                </h3>
                <div id="risk-pie-chart"></div>
            </div>

            <!-- Risk by Region Bar Chart -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-xl font-bold mb-4 text-gray-800">
                    <i class="fas fa-map-marker-alt text-green-600 mr-2"></i>
                    Restaurants par R√©gion
                </h3>
                <div id="region-bar-chart"></div>
            </div>
        </div>

        <!-- Charts Row 2 -->
        <div class="grid md:grid-cols-2 gap-6 mb-6">
            <!-- Cuisine Type Distribution -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-xl font-bold mb-4 text-gray-800">
                    <i class="fas fa-utensils text-purple-600 mr-2"></i>
                    Types de Cuisine
                </h3>
                <div id="cuisine-bar-chart"></div>
            </div>

            <!-- Risk Probability Gauge -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-xl font-bold mb-4 text-gray-800">
                    <i class="fas fa-tachometer-alt text-orange-600 mr-2"></i>
                    Niveau de Risque Moyen
                </h3>
                <div id="risk-gauge"></div>
            </div>
        </div>

        <!-- Additional Info -->
        <div class="bg-blue-50 border-l-4 border-blue-600 p-6 rounded-lg">
            <div class="flex items-start">
                <i class="fas fa-info-circle text-blue-600 text-2xl mr-4 mt-1"></i>
                <div>
                    <h4 class="font-bold text-gray-800 mb-2">√Ä propos des donn√©es</h4>
                    <p class="text-gray-700">
                        Les statistiques affich√©es sont bas√©es sur les donn√©es d'inspection MAPAQ. 
                        Le moteur de probabilit√©s conditionnelles v2 analyse plusieurs facteurs pour 
                        pr√©dire le niveau de risque sanitaire de chaque restaurant.
                    </p>
                    <p class="text-gray-600 text-sm mt-2">
                        <strong>Facteurs analys√©s:</strong> Type de cuisine, nombre d'employ√©s, historique d'infractions, 
                        taille de la cuisine, r√©gion g√©ographique, et ajustements r√©glementaires temporels.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8 mt-12">
        <div class="container mx-auto px-6 text-center">
            <p class="mb-2">¬© 2025 MAPAQ Risk Intelligence - Dashboard Interactif</p>
            <p class="text-gray-400">D√©velopp√© par <strong>Grace Mandiangu</strong></p>
        </div>
    </footer>

    <script>
        // Charger les statistiques au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            loadStatistics();
        });

        async function loadStatistics() {
            try {
                const response = await fetch('/api/statistics');
                const data = await response.json();
                
                // Mettre √† jour les cartes de statistiques
                document.getElementById('total-restaurants').textContent = data.total_restaurants.toLocaleString();
                document.getElementById('low-risk').textContent = data.risk_distribution.Low.toLocaleString();
                document.getElementById('medium-risk').textContent = data.risk_distribution.Medium.toLocaleString();
                document.getElementById('high-risk').textContent = data.risk_distribution.High.toLocaleString();
                
                // Cr√©er les graphiques
                createRiskPieChart(data.risk_distribution);
                createRegionBarChart(data.by_region);
                createCuisineBarChart(data.by_cuisine);
                createRiskGauge(data.risk_distribution, data.total_restaurants);
                
            } catch (error) {
                console.error('Erreur lors du chargement des statistiques:', error);
            }
        }

        function createRiskPieChart(riskData) {
            const data = [{
                values: [riskData.Low, riskData.Medium, riskData.High],
                labels: ['Risque Faible', 'Risque Moyen', 'Risque √âlev√©'],
                type: 'pie',
                marker: {
                    colors: ['#10b981', '#f59e0b', '#ef4444']
                },
                textinfo: 'label+percent',
                textposition: 'inside',
                hoverinfo: 'label+value+percent'
            }];

            const layout = {
                height: 350,
                margin: { t: 20, b: 20, l: 20, r: 20 },
                showlegend: true,
                legend: {
                    orientation: 'h',
                    y: -0.1
                }
            };

            Plotly.newPlot('risk-pie-chart', data, layout, {responsive: true});
        }

        function createRegionBarChart(regionData) {
            const regions = Object.keys(regionData);
            const values = Object.values(regionData);

            const data = [{
                x: regions,
                y: values,
                type: 'bar',
                marker: {
                    color: '#3b82f6',
                    line: {
                        color: '#1e40af',
                        width: 1.5
                    }
                },
                text: values.map(v => v.toLocaleString()),
                textposition: 'outside'
            }];

            const layout = {
                height: 350,
                margin: { t: 20, b: 60, l: 60, r: 20 },
                xaxis: {
                    title: 'R√©gion'
                },
                yaxis: {
                    title: 'Nombre de Restaurants'
                }
            };

            Plotly.newPlot('region-bar-chart', data, layout, {responsive: true});
        }

        function createCuisineBarChart(cuisineData) {
            const cuisines = Object.keys(cuisineData);
            const values = Object.values(cuisineData);

            const data = [{
                x: cuisines,
                y: values,
                type: 'bar',
                marker: {
                    color: '#8b5cf6',
                    line: {
                        color: '#6d28d9',
                        width: 1.5
                    }
                },
                text: values.map(v => v.toLocaleString()),
                textposition: 'outside'
            }];

            const layout = {
                height: 350,
                margin: { t: 20, b: 80, l: 60, r: 20 },
                xaxis: {
                    title: 'Type de Cuisine',
                    tickangle: -45
                },
                yaxis: {
                    title: 'Nombre de Restaurants'
                }
            };

            Plotly.newPlot('cuisine-bar-chart', data, layout, {responsive: true});
        }

        function createRiskGauge(riskData, total) {
            // Calculer le score de risque moyen (0-100)
            const lowPercent = (riskData.Low / total) * 100;
            const mediumPercent = (riskData.Medium / total) * 100;
            const highPercent = (riskData.High / total) * 100;
            
            // Score: Low = 0-33, Medium = 34-66, High = 67-100
            const avgScore = (lowPercent * 16.5) + (mediumPercent * 50) + (highPercent * 83.5);

            const data = [{
                type: "indicator",
                mode: "gauge+number+delta",
                value: avgScore,
                title: { text: "Score de Risque Global", font: { size: 18 } },
                delta: { reference: 50 },
                gauge: {
                    axis: { range: [null, 100], tickwidth: 1, tickcolor: "darkblue" },
                    bar: { color: avgScore < 33 ? "#10b981" : avgScore < 67 ? "#f59e0b" : "#ef4444" },
                    bgcolor: "white",
                    borderwidth: 2,
                    bordercolor: "gray",
                    steps: [
                        { range: [0, 33], color: '#d1fae5' },
                        { range: [33, 67], color: '#fef3c7' },
                        { range: [67, 100], color: '#fee2e2' }
                    ],
                    threshold: {
                        line: { color: "red", width: 4 },
                        thickness: 0.75,
                        value: 67
                    }
                }
            }];

            const layout = {
                height: 350,
                margin: { t: 40, b: 20, l: 20, r: 20 }
            };

            Plotly.newPlot('risk-gauge', data, layout, {responsive: true});
        }
    </script>
</body>
</html>
